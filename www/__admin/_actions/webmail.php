<?phpfunction getMbox($user, $pwd){	$mbox = new phpmailbox;	$mbox->host = IMAP_HOST;	$mbox->port = IMAP_PORT;	$mbox->user = $user;	$mbox->pass = $pwd;	$mbox->mailbox = "Inbox";	$mbox->protocol = "imap";		if (IMAP_SSL){		$mbox->flags[] = "ssl";	}	return $mbox;}function tryConnect(){	$mbox = getMbox($_SESSION['wm_user'], $_SESSION['wm_pwd']);	if ($mbox->Open()){		return $mbox;	}else{		action_login();		die();	}}function myhtmlentities($text){	return str_replace(array("<", ">", "/>", "</"), array("&lt;", "&gt;", "/&gt;", "&lt;/"), $text);}function print_style(){?><style type="text/css">		body{margin:0px; padding:0px; font-family: Arial; color: #777; font-size:11pt;}				#menu{		  background: #444;		  color:white;		  margin: 0px 0px 40px 0px;		  padding: 0px;		  height: 36px;		}				#menu a{			font-weight:bold;			color:white;			text-decoration:none;			padding: 0px 10px;		}				#container{			width:90%;			margin:0px auto;			border:1px solid #888;		}		        .page-selector{            width: 90%;            margin: 10px auto;        }        		tr.odd{ background: #dedede; }		tr.even{ background: #fff; }				.unseen *{ font-weight:bold; }		.seen *{ font-weight:normal; }				th{ text-transform: uppercase; background: #eef;}				table#inbox{width:100%}				table a { color: #333; text-decoration:none;}		table a:hover { color: blue; text-decoration:underline;}</style><?php}function print_menu(){?>	<div id="menu">		<div style="height:10px"></div>		<a href="?action=webmail&wm_action=inbox">Inbox</a>		<a href="?action=webmail&wm_action=compose">Compose</a>		<a href="?action=webmail&wm_action=logoff">Logoff</a>	</div>	<?php}// Actionsfunction action_login(){	if($_REQUEST['wm_user']){		$mbox = getMbox($_REQUEST['wm_user'], $_REQUEST['wm_pwd']);		if ($mbox->Open()){			$_SESSION['wm_user'] = $_REQUEST['wm_user'];			$_SESSION['wm_pwd'] = $_REQUEST['wm_pwd'];						action_inbox();		}else{			action_login();		}	}else{ // Display Form?><!DOCTYPE html><html>  <head><title>WebMail | Login</title></head>    <body onload="document.getElementById('wm_user').focus()">	<div style="width: 300px; margin: 150px auto; border:1px solid #777">		<h4 style="margin: 0px; padding: 4px 10px; border-bottom: solid 1px #777; background:#ddd; overflow:hidden">Login</h4>				<form action="" method="post">			<input type="hidden" name="action" value="webmail">			<input type="hidden" name="wm_action" value="login">						<table style="width: 100%; margin: 0px; padding: 8px; background:#eee">				<tr>					<td style="width:80px; padding:8px;"><label>User :</label></td>					<td><input id="wm_user" name="wm_user" type="text"></td>				</tr>								<tr>					<td style="width:80px; padding:8px;"><label>Password :</label></td>					<td><input id="wm_pwd" name="wm_pwd" type="password"></td>				</tr>								<tr>					<td style="width:80px; padding:8px;"></td>					<td><input type="submit" value="Login"></td>				</tr>			</table>					</form>	</div>  </body></html><?php	}}function action_inbox(){        $mbox = tryConnect();	$c = $mbox->Count();        $start = $_REQUEST['start'] ? $_REQUEST['start'] : 1;    $end = min($start + 99, $c);    	$k = $start;?><!DOCTYPE html><html><head>  <title>Webmail | Inbox</title>  <?php print_style(); ?></head>  <body>  <?php print_menu(); ?>    <div id="container">  <form action="" method="post">  <input type="hidden" name="action" value="webmail">  <input type="hidden" name="wm_action" value="delete">  <table id="inbox">	<tr>	  <th style="width:5%">#</th>	  <th style="width:5%"></th>	  <th style="width:30%">Subject</th>	  <th style="width:30%">From</th>	  <th style="width:20px">Date</th>	  <th style="width:10%">Size</th>	</tr>	<?php foreach($mbox->Overview($start, $end) as $key => $msg): ?>	  	  <tr class="tr-<?= ($k % 2) ? "odd" : "even";  ?> <?php print $msg->unseen ? "unseen" : "seen"; ?>">		<td><input type="checkbox" name="delete[]" value="<?php print $key ?>"></td>		<td><?php print $k; ?></td>		<td><a href="?action=webmail&wm_action=read&num=<?php print $key ?>">			- <?php print myhtmlentities($msg->subject); ?>			</a>		</td>		<td><?php print myhtmlentities($msg->from[0]) ?></td>		<td><?php print date("Y/m/d h:i A", $msg->udate); ?></td>		<td><?php print $msg->size > 1024 ? ($msg->size > 1024 * 1024 ? floor($msg->size / (1024 * 1024)) . "mb" : floor($msg->size / 1024) . "kb") : $msg->size . "b" ?></td>	  </tr>	<?php $k++; ?>  	<?php endforeach; ?>  </table>  <input type="submit" value="DELETE SELECTED">  </form>  </div>    <div class="page-selector">  <?php    $nPages = ceil($c / 100);    $currPage = ceil($start / 100);    $minPageInSelector = max(1, $currPage - 4);    $maxPageInSelector = min($nPages, $minPageInSelector + 9);  ?>  <a href="?action=webmail&wm_action=webpage&start=1">1ra Página</a>&nbsp;&nbsp;|&nbsp;&nbsp;  <?php for($i = $minPageInSelector; $i <= $maxPageInSelector; $i++): ?>    <a href="?action=webmail&wm_action=inbox&start=<?= (($i-1) * 100) + 1 ?>"><?= $i ?></a>&nbsp;&nbsp;|&nbsp;&nbsp;  <?php endfor; ?>  <a href="?action=webmail&wm_action=inbox&start=<?= max(0, (($nPages - 1) * 100) + 1) ?>">Última Página (<?= $nPages ?>)</a>  </div></body></html><?php}function action_logoff(){	unset($_SESSION['wm_user'], $_SESSION['wm_pwd']);	action_login();}function action_read(){	$mbox = tryConnect();	$msg = $mbox->Message($_REQUEST['num']);	if (!$msg) {die("El mensaje no existe");}	?><!DOCTYPE html ><html><head>  <title>Webmail | Read</title>  <?php print_style(); ?></head><body>  <?php print_menu(); ?>    <?if ($_REQUEST['sent']):?>  <p style="background:green">El mensaje fue enviado.</p>  <?endif;?>    <div id="container">	<div id="m-from"><label>From : </label><span><?php print myhtmlentities(implode(',', $msg->from)); ?></span></div>	<div id="m-to"><label>To : </label><span><?php print myhtmlentities(implode(',', $msg->to)); ?></span></div>	<div id="m-subject"><label>Subject : </label><span><?php print myhtmlentities($msg->subject); ?></span></div>    <div id="m-action-bar"> <a href="?action=send_message&success_url=<?= urlencode( "{$_SERVER['REQUEST_URI']}&sent=1" ) ?>&to=<?= count($msg->reply_to) > 0 ? urlencode($msg->reply_to[0]) : urlencode($msg->from[0]) ?>&from=<?= $msg->to[0] ?>&subject=Re:%20<?= urlencode($msg->subject) ?>&body=%3E<?= urlencode(str_replace("\n", "\n>", $msg->isHtml ? $msg->altBody : $msg->body)) ?>">Responder</a> &nbsp;&nbsp;|&nbsp;&nbsp;    <a href="?action=send_message&success_url=<?= urlencode( "{$_SERVER['REQUEST_URI']}&sent=1" ) ?>&from=<?= $msg->from[0] ?>&subject=Fw:%20<?= urlencode($msg->subject) ?>&body=<?= urlencode(str_replace("\n", "\n>", $msg->isHtml ? $msg->altBody : $msg->body)) ?>">Reenviar</a></div>	<div id="text" style="border: 1px solid ">	  <?php print ($msg->isHtml ? $msg->body : "<pre>" . myhtmlentities($msg->body) . "</pre>"); ?>	</div>	<?php if ($msg->altBody): ?>	<div id="alt-text" style="border: 1px solid #444">	  <h4>Alternative :</h4>	  <?php print "<pre>" . myhtmlentities($msg->altBody) . "</pre>"; ?>	</div>	<?php endif; ?>	<div id="attachments">		<h4>Attachments : </h4>		<div>		<?php $k = 0; ?>		<?php foreach($msg->attachments as $att): ?>		  <a href="?action=webmail&wm_action=attachment&num=<?php print $_REQUEST['num'] ?>&att_num=<?php print $k; $k++; ?>"><?php print "{$att->name} (" . strlen($att->content) . " bytes)"; ?></a>&nbsp;&nbsp;|&nbsp;		<?php endforeach; ?>		</div>	</div>	  </div></body></html><?php}function action_attachment(){	$mbox = tryConnect();		if (($msg = $mbox->Message($_REQUEST['num'])) &&		($att = $msg->attachments[$_REQUEST['att_num']])){				//var_dump($att); die();				header("Content-Type: {$att->mimetype}");		header("Content-Disposition: attachment; filename=\"{$att->name}\"");				print($att->content);	}}function action_delete(){	if (is_array($_REQUEST['delete'])){		$range = implode(",", $_REQUEST['delete']);		$mbox = tryConnect();		$mbox->DeleteRange($range);		$mbox->Close(true);	}		action_inbox();}function action_compose(){if (EPHelper::is_valid_email($_POST['to'])){	$to = $_POST['to'];	$subject = $_POST['subject'];	$body = $_POST['body'];	$from = $_POST['from'];	$fromName = $_POST['from_name'];		$att = array();	foreach ($_FILES as $file){		if (is_uploaded_file($file['tmp_name'])){			$att[] = array(				'name' => basename($file['name']),				'data' => file_get_contents($file['tmp_name'])			);			unlink($file['tmp_name']);		}	}		if (EPHelper::SendMail($to, $subject, $body, $att, $from, $fromName)){		print "Message Sent to '$to' from $fromName <$from> with subject '$subject' and " 					. count($att) . " attachments";	}else{		print "<b>Failed</b> to send message '$to' from $fromName <$from> with subject '$subject' and " 					. count($att) . " attachments";	}}else{?><!DOCTYPE html><html>  <head>   <title>SendMessage</title>   <?php print_style(); ?>  </head>    <body>  <?php print_menu(); ?>	<div id="container">	<h3>SendMessage</h3>    <form action="" method="post" enctype="multipart/form-data">	  <input name="action" value="webmail" type="hidden">	  <input name="wm_action" value="compose" type="hidden">	  <label>To :</label><br>	  <input name="to" type="text"><br><br>	  	  <label>Subject :</label><br>	  <input name="subject" type="text"><br><br>	  	  <label>From :</label><br>	  <input name="from" type="text" value="<?php print $_SESSION['wm_user']; ?>"><br><br>	  	  <label>From Name :</label><br>	  <input name="from_name" type="text"><br><br>	  	  <input value="SEND" type="submit"><br><br>	  	  <label>Text :</label><br>	  <textarea name="body" rows="10" cols="60"></textarea><br><br>	  	  <label>Attachment 1 :</label><br>	  <input name="att_1" type="file"><br><br>	  	  <label>Attachment 2 :</label><br>	  <input name="att_2" type="file"><br><br>	  	  <label>Attachment 3 :</label><br>	  <input name="att_3" type="file"><br><br>	  	</form>		</div>  </body></html><?php}}function action_download(){	$mbox = tryConnect();	$c = $mbox->Count();		$zipFile = new ZipFile;		for($i = 1; $i <= $c; $i++){		$zipFile->AddFromString("message-{$i}.eml", $mbox->RawMessage($i));	}		//$mbox->DeleteRange("1:{$c}");	$mbox->Close();		header("Content-Type: application/zip");	header("Content-Disposition: attachment; filename=\"messages.zip\"");		print $zipFile->Save();}function action_delete_all(){	$mbox = tryConnect();    $mbox->DeleteRange("1:" . $mbox->Count());    $mbox->Close(true);        action_inbox();}if (function_exists($action = "action_" . $_REQUEST['wm_action'])){	$action();}else{	action_inbox();}